<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akıllı Sulama Sistemi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card { margin-bottom: 1rem; }
        .system-metrics { font-size: 0.9rem; }
        #cameraImage { max-width: 100%; height: auto; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Akıllı Sulama Sistemi</h1>
        <p class="text-muted">Son güncelleme: <span id="lastUpdate">--:--:--</span></p>
        
        <!-- Sensör Verileri -->
        <div class="row">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Sıcaklık</h5>
                        <h2 id="temperature">--°C</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Nem</h5>
                        <h2 id="humidity">--%</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Toprak Nemi</h5>
                        <h2 id="soilMoisture">--</h2>
                        <p class="mb-0">Yüzde: <span id="soilMoisturePercent">--%</span></p>
                        <p class="mb-0">Ham Değer: <span id="soilMoistureRaw">--</span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Işık</h5>
                        <h2 id="light">--%</h2>
                        <p class="mb-0">Ham Değer: <span id="lightRaw">--</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Su Pompası Kontrolü -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Su Pompası Kontrolü</h5>
            </div>
            <div class="card-body">
                <p>Durum: <span id="pumpStatus" class="badge bg-secondary">--</span></p>
                <button id="pumpOn" class="btn btn-success">Pompayı Çalıştır</button>
                <button id="pumpOff" class="btn btn-danger">Pompayı Durdur</button>
            </div>
        </div>

        <!-- Kamera Görüntüsü -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Kamera</h5>
            </div>
            <div class="card-body text-center">
                <img id="cameraImage" src="" class="mb-3" alt="Kamera görüntüsü">
                <br>
                <button id="takeSnapshot" class="btn btn-primary">Fotoğraf Çek</button>
            </div>
        </div>

        <!-- Sistem Durumu -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">Sistem Durumu</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Raspberry Pi -->
                    <div class="col-md-6">
                        <h6>Raspberry Pi</h6>
                        <table class="table table-sm">
                            <tr>
                                <td>CPU Kullanımı</td>
                                <td id="cpu_percent">--%</td>
                            </tr>
                            <tr>
                                <td>CPU Sıcaklığı</td>
                                <td id="cpu_temp">--°C</td>
                            </tr>
                            <tr>
                                <td>RAM Kullanımı</td>
                                <td id="ram_percent">--%</td>
                            </tr>
                            <tr>
                                <td>Disk Kullanımı</td>
                                <td id="disk_percent">--%</td>
                            </tr>
                            <tr>
                                <td>Network (Gönderilen/Alınan)</td>
                                <td id="network_io">-- MB / -- MB</td>
                            </tr>
                        </table>
                    </div>
                    <!-- ESP32 -->
                    <div class="col-md-6">
                        <h6>ESP32</h6>
                        <table class="table table-sm">
                            <tr>
                                <td>CPU Frekansı</td>
                                <td id="esp_cpu_freq">-- MHz</td>
                            </tr>
                            <tr>
                                <td>Boş Hafıza</td>
                                <td id="esp_free_heap">-- KB</td>
                            </tr>
                            <tr>
                                <td>WiFi Sinyal</td>
                                <td id="esp_wifi_rssi">-- dBm</td>
                            </tr>
                            <tr>
                                <td>IP Adresi</td>
                                <td id="esp_wifi_ip">--</td>
                            </tr>
                            <tr>
                                <td>Çalışma Süresi</td>
                                <td id="esp_uptime">--:--:--</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sensör verilerini güncelle
        function updateSensors() {
            fetch('/api/sensors')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('temperature').textContent = data.temperature + '°C';
                    document.getElementById('humidity').textContent = data.humidity + '%';
                    document.getElementById('soilMoisture').textContent = data.soil_moisture.state || '--';
                    document.getElementById('soilMoisturePercent').textContent = data.soil_moisture.percent + '%';
                    document.getElementById('soilMoistureRaw').textContent = data.soil_moisture.analog;
                    document.getElementById('light').textContent = data.light.percent + '%';
                    document.getElementById('lightRaw').textContent = data.light.raw;
                    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
                });
        }

        // Raspberry Pi sistem metriklerini güncelle
        function updateSystemMetrics() {
            fetch('/api/system/metrics')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('cpu_percent').textContent = data.cpu.percent.toFixed(1) + '%';
                    document.getElementById('cpu_temp').textContent = data.cpu.temperature.toFixed(1) + '°C';
                    document.getElementById('ram_percent').textContent = data.memory.percent.toFixed(1) + '%';
                    document.getElementById('disk_percent').textContent = data.disk.percent.toFixed(1) + '%';
                    
                    const sent = (data.network.bytes_sent / 1024 / 1024).toFixed(1);
                    const recv = (data.network.bytes_recv / 1024 / 1024).toFixed(1);
                    document.getElementById('network_io').textContent = `${sent} MB / ${recv} MB`;
                });
        }

        // ESP32 sistem metriklerini güncelle
        function updateESPMetrics() {
            fetch('/api/system/esp_metrics')
                .then(response => response.json())
                .then(data => {
                    if (Object.keys(data).length > 0) {
                        document.getElementById('esp_cpu_freq').textContent = data.cpu_freq + ' MHz';
                        document.getElementById('esp_free_heap').textContent = (data.free_heap / 1024).toFixed(1) + ' KB';
                        document.getElementById('esp_wifi_rssi').textContent = data.wifi.rssi + ' dBm';
                        document.getElementById('esp_wifi_ip').textContent = data.wifi.ip;
                        
                        const uptime = data.uptime_seconds;
                        const hours = Math.floor(uptime / 3600);
                        const minutes = Math.floor((uptime % 3600) / 60);
                        const seconds = uptime % 60;
                        document.getElementById('esp_uptime').textContent = 
                            `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    }
                });
        }

        // Pompa kontrolü
        document.getElementById('pumpOn').addEventListener('click', () => {
            fetch('/api/pump/on', { method: 'POST' })
                .then(() => {
                    document.getElementById('pumpStatus').textContent = 'AÇIK';
                    document.getElementById('pumpStatus').className = 'badge bg-success';
                });
        });

        document.getElementById('pumpOff').addEventListener('click', () => {
            fetch('/api/pump/off', { method: 'POST' })
                .then(() => {
                    document.getElementById('pumpStatus').textContent = 'KAPALI';
                    document.getElementById('pumpStatus').className = 'badge bg-danger';
                });
        });

        // Kamera kontrolü
        document.getElementById('takeSnapshot').addEventListener('click', () => {
            fetch('/api/camera/snapshot')
                .then(response => response.json())
                .then(data => {
                    if (data.image) {
                        document.getElementById('cameraImage').src = data.image;
                    } else {
                        alert('Fotoğraf çekilemedi!');
                    }
                })
                .catch(error => {
                    console.error('Hata:', error);
                    alert('Bir hata oluştu!');
                });
        });

        // Periyodik güncelleme
        setInterval(updateSensors, 20000);  // Her 20 saniyede bir
        setInterval(updateSystemMetrics, 30000);  // Her 30 saniyede bir
        setInterval(updateESPMetrics, 30000);  // Her 30 saniyede bir

        // İlk yükleme
        updateSensors();
        updateSystemMetrics();
        updateESPMetrics();
    </script>
</body>
</html>